<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#050006;
  --card:#0d0011;
  --card-light:#150019;
  --accent:#b44bff;
  --accent-glow:#c56cff;
  --accent-soft:#b44bff33;
  --text:#ffffff;
  --text-muted:#9a7fa8;
  --border:#26002e;
  --radius:16px;
  --error:#ff3860;
}

/* ===== Base ===== */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg,var(--bg) 0%, #07020b 100%);
  color: var(--text);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:20px;
}

/* ===== Header ===== */
header{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  text-align:center;
  padding:18px 0;
  font-size:1.8em;
  font-weight:700;
  background:linear-gradient(180deg,#160018,#08000a);
  border-bottom:1px solid var(--border);
  box-shadow:0 6px 28px #b44bff11;
  color:white;
  z-index:10;
}

/* ===== Container ===== */
.container{
  width:100%;
  max-width:480px;
  margin-top:90px;
  background: var(--card);
  padding:30px;
  border-radius:var(--radius);
  box-shadow:0 8px 30px rgba(180,75,255,0.06);
  display:flex;
  flex-direction:column;
  gap:18px;
  animation:fadeIn 0.5s ease;
}

label{
  font-size:1.1em;
  color:var(--accent);
  font-weight:600;
}

input, select{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--accent);
  background:var(--card-light);
  color:var(--text);
  font-size:1em;
  margin-bottom:12px;
  transition:0.2s;
}

input:focus, select:focus{
  outline:none;
  box-shadow:0 0 12px var(--accent-soft);
  border-color:var(--accent-glow);
}

button{
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:1.1em;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
  background: linear-gradient(90deg,var(--accent),var(--accent-glow));
  color:white;
  box-shadow:0 6px 20px var(--accent-soft);
}

button:hover{
  background: linear-gradient(90deg,var(--accent-glow),var(--accent));
  transform:translateY(-2px);
}

.note{
  padding:15px;
  background:#2a1f47;
  border-left:4px solid var(--accent);
  border-radius:8px;
  font-size:0.95em;
  color:#d4c6ff;
  line-height:1.4em;
}

/* Notification */
.notif-box{
  position:fixed;
  top:18px;
  right:18px;
  background:var(--accent);
  color:white;
  padding:12px 16px;
  border-radius:12px;
  font-size:14px;
  box-shadow:0 12px 40px #b44bff33;
  z-index:9999;
  opacity:1;
  transition:opacity 0.3s;
}
.notif-box.error{ background: var(--error); }

/* Modal (Grande) */
.modal-bg{ 
  position:fixed; inset:0; 
  background:rgba(0,0,0,0.7); 
  display:none; 
  align-items:center; 
  justify-content:center; 
  z-index:1000; 
}

.modal{
  background:var(--card);
  padding:22px;
  border-radius:14px;
  width:90%;
  max-width:420px;
  border:1px solid var(--border);
  box-shadow:0 14px 40px #b44bff22;
  text-align:center;
  color:white;
  animation:popIn 0.25s ease-out;
}

.modal h3{
  color:var(--accent);
  margin-top:0;
}

/* Popup pequeño futurista */
.small-popup-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.small-popup {
  background: #0b0010;
  border: 1px solid #b44bff55;
  width: 280px;
  padding: 18px 20px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 0 25px #b44bff33;
  animation: popIn 0.22s ease-out;
}

.small-popup h4 {
  margin: 0 0 8px 0;
  color: #c56cff;
  font-size: 1.1em;
  font-weight: 700;
}

.small-popup p {
  color: #d9c4ff;
  font-size: 0.95em;
  line-height: 1.35em;
}

.small-popup button {
  margin-top: 14px;
  padding: 8px 18px;
  background: linear-gradient(90deg,#b44bff,#d08aff);
  border: none;
  border-radius: 10px;
  color: white;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9em;
  box-shadow: 0 0 12px #b44bff55;
}

.small-popup button:hover {
  transform: translateY(-2px);
}

@keyframes popIn{
  from{opacity:0; transform:scale(0.85);}
  to{opacity:1; transform:scale(1);}
}

@keyframes fadeIn{ 
  from{opacity:0;transform:translateY(10px);} 
  to{opacity:1;transform:translateY(0);} 
}
</style>
</head>
<body>

<header>Withdraw</header>

<div class="container">

  <div class="note" id="clockNote">
    <strong>Hora Londres:</strong> <span id="londonClock">--:--:--</span>
  </div>

  <div class="note">
    <strong>Horario permitido:</strong><br>
    ➤ 6:00 AM – 11:00 AM (Hora Londres) <br>
    ➤ Lunes a Viernes<br>
    ➤ Monto mínimo: <strong>10 USDT</strong> <br>
    ➤ Solo 1 retiro diario
  </div>

  <label for="network">Red de Retiro</label>
  <select id="network">
    <option value="">Seleccionar red</option>
    <option value="bep20">BEP20 (BSC)</option>
    <option value="trc20">TRC20 (Tron)</option>
  </select>

  <label for="address">Dirección</label>
  <input type="text" id="address" placeholder="Dirección USDT">

  <label for="amount">Monto (USDT)</label>
  <input type="number" id="amount" placeholder="Ej: 50">

  <div class="note" id="noteFee">
    <strong>Comisión:</strong> <span id="fee">0</span> USDT <br>
    <strong>Monto final:</strong> <span id="final">0</span> USDT
  </div>

  <button id="withdrawBtn">Retirar</button>
</div>

<!-- Modal grande -->
<div class="modal-bg" id="modalBG">
  <div class="modal">
    <h3>Retiro en Proceso</h3>
    <p>Su solicitud de retiro ha sido registrada correctamente y será procesada en un plazo máximo de 48 horas hábiles.</p>
  </div>
</div>

<!-- Popup pequeño -->
<div class="small-popup-bg" id="smallPopupBg">
  <div class="small-popup">
    <h4 id="smallPopupTitle">Aviso</h4>
    <p id="smallPopupText">Texto</p>
    <button onclick="closeSmallPopup()">Aceptar</button>
  </div>
</div>

<script type="module">

/* =========  FIREBASE  ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, where, getDocs,
  doc, runTransaction, setDoc, serverTimestamp, limit
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB0JbG_AXXOveg1lERODRJ8xw5vAtEMzV4",
  authDomain: "clashgpt-8a055.firebaseapp.com",
  projectId: "clashgpt-8a055",
  storageBucket: "clashgpt-8a055.firebasestorage.app",
  messagingSenderId: "152687596916",
  appId: "1:152687596916:web:8c8068c6d347d9d9198821"
};

initializeApp(firebaseConfig);
const db = getFirestore();
const auth = getAuth();

/* ========= UI ELEMENTOS ========= */
const amountInput = document.getElementById("amount");
const feeBox = document.getElementById("fee");
const finalBox = document.getElementById("final");
const withdrawBtn = document.getElementById("withdrawBtn");
const modalBG = document.getElementById("modalBG");
const londonClock = document.getElementById("londonClock");

/* ========= POPUP PEQUEÑO ========= */
window.showSmallPopup = function(title, text){
  document.getElementById("smallPopupTitle").textContent = title;
  document.getElementById("smallPopupText").textContent = text;
  document.getElementById("smallPopupBg").style.display = "flex";
};

window.closeSmallPopup = function(){
  document.getElementById("smallPopupBg").style.display = "none";
};

/* ========= Notificación ========= */
function showNotification(msg, type='success', timeout=2000){
  const box = document.createElement('div');
  box.className = 'notif-box' + (type==='error' ? ' error' : '');
  box.textContent = msg;
  document.body.appendChild(box);
  setTimeout(()=> box.style.opacity='0', timeout-200);
  setTimeout(()=> box.remove(), timeout+200);
}

/* ========= Reloj Londres ========= */
function updateLondonClock() {
  const now = new Date();
  const time = new Intl.DateTimeFormat("en-GB", {
    timeZone: "Europe/London",
    hour12: false,
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  }).format(now);
  londonClock.textContent = time;
}
setInterval(updateLondonClock, 1000);
updateLondonClock();

/* ========= Cálculo de comisión ========= */
amountInput.addEventListener("input", ()=>{
  const amount = parseFloat(amountInput.value);
  if(isNaN(amount) || amount<=0){
    feeBox.textContent='0';
    finalBox.textContent='0';
    return;
  }
  const fee = amount < 99 ? 1 : amount * 0.05;
  feeBox.textContent = fee.toFixed(2);
  finalBox.textContent = (amount - fee).toFixed(2);
});

/* ========= Validación direcciones ========= */
function isValidAddress(address, network){
  if(network === "bep20")
    return /^0x[a-fA-F0-9]{40}$/.test(address);

  if(network === "trc20")
    return /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(address);

  return false;
}

/* ========= Fecha Londres ========= */
function londonDateISO() {
  const formatter = new Intl.DateTimeFormat("en-GB", {
    timeZone: "Europe/London",
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });

  const parts = formatter.formatToParts(new Date());
  const day = parts.find(p => p.type === "day").value;
  const month = parts.find(p => p.type === "month").value;
  const year = parts.find(p => p.type === "year").value;

  return `${year}-${month}-${day}`;
}

/* ========= Horario Londres 6AM-11AM, Lunes-Viernes ========= */
function isLondonTimeAllowed() {
  const now = new Date();
  const options = { timeZone: "Europe/London", hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit", weekday: "short" };
  const parts = new Intl.DateTimeFormat("en-GB", options).formatToParts(now);

  const hour = parseInt(parts.find(p => p.type === "hour").value);
  const minute = parseInt(parts.find(p => p.type === "minute").value);
  const weekday = parts.find(p => p.type === "weekday").value; // Mon, Tue, ..., Sat, Sun

  // Revisar fines de semana
  if(weekday === "Sat" || weekday === "Sun") return false;

  // Revisar horario 6AM - 11AM
  const nowMinutes = hour * 60 + minute;
  const openMinutes = 6 * 60;   // 6:00 AM
  const closeMinutes = 11 * 60; // 11:00 AM

  return nowMinutes >= openMinutes && nowMinutes < closeMinutes;
}

/* ========= MAIN ========= */
onAuthStateChanged(auth, async user=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }

  const uid = user.uid;

  withdrawBtn.addEventListener("click", async ()=>{

    const network = document.getElementById("network").value;
    const address = document.getElementById("address").value.trim();
    const amount = parseFloat(amountInput.value);

    if(!network || !address || !amount){
      showSmallPopup("Campos incompletos","Debe completar todos los datos.");
      return;
    }

    if(!isValidAddress(address, network)){
      showSmallPopup("Dirección inválida","La dirección no coincide con la red seleccionada.");
      return;
    }

    if(amount < 10){
      showSmallPopup("Monto inválido","El monto mínimo es de 10 USDT.");
      return;
    }

    if(!isLondonTimeAllowed()){
      showSmallPopup(
        "No Disponible",
        "Los retiros solo están habilitados de 6:00 AM a 11:00 AM (Londres), de lunes a viernes."
      );
      return;
    }

    const today = londonDateISO();
    const q = query(
      collection(db, "withdraw"),
      where("uid", "==", uid),
      where("dayKey", "==", today),
      limit(1)
    );

    const snap = await getDocs(q);
    if(!snap.empty){
      showSmallPopup("Límite diario", "Solo se permite 1 retiro por día.");
      return;
    }

    const fee = amount < 99 ? 1 : amount * 0.05;
    const finalAmount = amount - fee;

    try{
      await runTransaction(db, async(tx)=>{

        const walletRef = doc(db, "users", uid, "wallet", "info");
        const walletSnap = await tx.get(walletRef);

        if(!walletSnap.exists()) throw new Error("No se encontró wallet");

        const currentBalance = Number(walletSnap.data().balance || 0);
        if(amount > currentBalance) throw new Error("Saldo insuficiente");

        // 1️⃣ Actualizar balance
        tx.set(walletRef, { balance: currentBalance - amount }, { merge:true });

        // 2️⃣ Crear documento en withdraw (colección global)
        const newId = crypto.randomUUID();
        const retiroRef = doc(db, "withdraw", newId);
        tx.set(retiroRef, {
          uid,
          amount,
          fee,
          finalAmount,
          network,
          address,
          estado: "pendiente",
          createdAt: serverTimestamp(),
          dayKey: today
        });

        // 3️⃣ Crear transacción en la colección del usuario
        const transRef = doc(collection(db, "users", uid, "transactions"));
        tx.set(transRef, {
          type: "Withdraw",
          amount,
          date: serverTimestamp(),
          network,
          address,
          status: "pendiente"
        });

      });

      amountInput.value='';
      document.getElementById("address").value='';
      feeBox.textContent='0';
      finalBox.textContent='0';

      modalBG.style.display='flex';
      setTimeout(()=> modalBG.style.display='none', 4500);

      showNotification("Retiro solicitado correctamente");

    }catch(err){
      showSmallPopup("Error", err.message || "Error al procesar el retiro");
    }

  });
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirmaci√≥n de Dep√≥sito</title>

<style>
:root{
  --bg:#050006;
  --card:#0d0011;
  --card-light:#150019;
  --accent:#b44bff;
  --accent-glow:#c56cff;
  --accent-soft:#b44bff33;
  --text:#ffffff;
  --text-muted:#9a7fa8;
  --border:#26002e;
  --radius:16px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg,var(--bg) 0%, #07020b 100%);
  color: var(--text);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}
header{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  text-align:center;
  padding:18px 0;
  font-size:1.8em;
  font-weight:700;
  background:linear-gradient(180deg,#160018,#08000a);
  border-bottom:1px solid var(--border);
  box-shadow:0 6px 28px #b44bff11;
  color:white;
  z-index:10;
}
.container{
  width:100%;
  max-width:480px;
  margin-top:90px;
  background: var(--card);
  padding:30px;
  border-radius:var(--radius);
  box-shadow:0 8px 30px rgba(180,75,255,0.06);
  display:flex;
  flex-direction:column;
  gap:18px;
  animation:fadeIn 0.5s ease;
}
label{
  font-size:1.1em;
  color:var(--accent);
  font-weight:600;
}
input, select{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--accent);
  background:var(--card-light);
  color:var(--text);
  font-size:1em;
  margin-bottom:12px;
  transition:0.2s;
}
input:focus, select:focus{
  outline:none;
  box-shadow:0 0 12px var(--accent-soft);
  border-color:var(--accent-glow);
}
button{
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:1.1em;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
  background: linear-gradient(90deg,var(--accent),var(--accent-glow));
  color:white;
  box-shadow:0 6px 20px var(--accent-soft);
}
button:hover{
  background: linear-gradient(90deg,var(--accent-glow),var(--accent));
  transform:translateY(-2px);
}
.note{
  margin-top:15px;
  padding:15px;
  background:#2a1f47;
  border-left:4px solid var(--accent);
  border-radius:8px;
  font-size:0.95em;
  color:#d4c6ff;
  line-height:1.4em;
}
.notif-box{
  position:fixed;
  top:18px;
  right:18px;
  background:var(--accent);
  color:white;
  padding:12px 16px;
  border-radius:12px;
  font-size:14px;
  box-shadow:0 12px 40px #b44bff33;
  z-index:9999;
  opacity:1;
  transition:opacity 0.3s;
}
.notif-box.error{ background: #ff4b4b; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
</style>
</head>
<body>

<header>Confirmaci√≥n de Dep√≥sito</header>

<div class="container">
  <form id="form-deposito">
    <label for="network">Red utilizada</label>
    <select id="network">
      <option value="">Seleccionar red</option>
      <option value="BEP20">USDT ‚Äì BEP20</option>
      <option value="TRC20">USDT ‚Äì TRC20</option>
    </select>

    <label for="amount">Monto enviado</label>
    <input type="number" id="amount" placeholder="Ej: 20 USDT">

    <label for="txid">TXID / Hash de la transacci√≥n</label>
    <input type="text" id="txid" placeholder="Pega aqu√≠ tu TXID completo">

    <button type="submit">Informar dep√≥sito</button>
  </form>

  <div class="note">
    <strong>¬øQu√© es el TXID?</strong><br><br>
    Es el c√≥digo √∫nico que identifica tu transacci√≥n en la blockchain.
    Una vez verificado, el saldo se acreditar√° autom√°ticamente en tu wallet.
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, where, getDocs 
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB0JbG_AXXOveg1lERODRJ8xw5vAtEMzV4",
  authDomain: "clashgpt-8a055.firebaseapp.com",
  projectId: "clashgpt-8a055",
  storageBucket: "clashgpt-8a055.appspot.com",
  messagingSenderId: "152687596916",
  appId: "1:152687596916:web:8c8068c6d347d9d9198821"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

function showNotification(msg,type='success',timeout=2000){
  const box = document.createElement('div');
  box.className = 'notif-box' + (type==='error'?' error':'');
  box.textContent = msg;
  document.body.appendChild(box);
  setTimeout(()=> box.style.opacity='0', timeout-200);
  setTimeout(()=> box.remove(), timeout+200);
}

const form = document.getElementById("form-deposito");

onAuthStateChanged(auth, user => {
  if(!user){
    showNotification("No se encontr√≥ el usuario. Inicia sesi√≥n primero.","error");
    setTimeout(()=> window.location.href="login.html",1500);
    return;
  }

  form.addEventListener("submit", async e=>{
    e.preventDefault();

    const network = document.getElementById("network").value;
    const amount = Number(document.getElementById("amount").value);

    // üî• Normalizar TXID a min√∫sculas
    const txid = document.getElementById("txid").value.trim().toLowerCase();

    if(!network || !amount || !txid){
      showNotification("Por favor completa todos los campos.","error");
      return;
    }

    try{
      // üî• Verificar si el TXID ya existe (en min√∫sculas)
      const q = query(
        collection(db,"depositos"),
        where("txid","==",txid)
      );

      const snap = await getDocs(q);

      if(!snap.empty){
        showNotification("‚ö†Ô∏è Este TXID ya fue registrado.","error");
        return;
      }

      // üü¢ Crear dep√≥sito
      const docRef = await addDoc(collection(db, "depositos"), {
        usuario: user.uid,
        network,
        monto: amount,
        txid: txid,   // Guardado en min√∫sculas
        estado: "pendiente",
        sumado: false,
        createdAt: new Date()
      });

      localStorage.setItem("depositId", docRef.id);
      showNotification("Dep√≥sito informado con √©xito!");
      setTimeout(()=> window.location.href="espera.html",1000);

    }catch(err){
      console.error(err);
      showNotification("Error al conectar con Firestore","error");
    }
  });
});
</script>

</body>
</html>
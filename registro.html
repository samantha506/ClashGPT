<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crear cuenta — ClashGPT</title>
<style>
:root{
  --morado:#7d2bff; --morado-2:#b062ff; --fondo-oscuro:#06060a;
  --card:#0f0b14; --texto:#eae6ff; --accent:#9b6cff;
  --success:#45c57a; --danger:#ff6b6b;
}
html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--fondo-oscuro); color:var(--texto); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.bg{position:fixed; inset:0; z-index:-3; overflow:hidden; background: linear-gradient(180deg, rgba(19,10,28,1) 0%, rgba(6,6,10,1) 60%);}
.bg::before{content:""; position:absolute; inset:-10%; background:linear-gradient(120deg, rgba(125,43,255,0.08), rgba(176,98,255,0.06), rgba(0,0,0,0)); transform:translateX(-10%); animation: drift 18s linear infinite;}
@keyframes drift { 0%{transform:translateX(-12%)} 50%{transform:translateX(12%)} 100%{transform:translateX(-12%)} }
.stars{position:absolute; inset:0; background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.06) 0 1px, transparent 1px), radial-gradient(circle at 60% 80%, rgba(255,255,255,0.045) 0 1px, transparent 1px), radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03) 0 1px, transparent 1px); opacity:0.7; filter:blur(0.2px); pointer-events:none;}
.wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; position:relative;}
.card{width:100%; max-width:620px; background: linear-gradient(180deg, rgba(18,9,23,0.9), rgba(12,7,16,0.95)); border-radius:14px; padding:26px; box-shadow: 0 10px 40px rgba(11,6,20,0.6); border:1px solid rgba(125,43,255,0.06); position:relative; overflow:hidden; backdrop-filter: blur(6px);}
.logo-float{position:absolute; top:-40px; left:50%; transform:translateX(-50%); width:80px; height:80px; background:linear-gradient(135deg,var(--morado),var(--morado-2)); border-radius:20px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:24px; color:white; box-shadow:0 10px 40px rgba(125,43,255,0.3); animation: floatLogo 3s ease-in-out infinite alternate; z-index:5;}
@keyframes floatLogo { 0%{ transform:translateX(-50%) translateY(0) } 100%{ transform:translateX(-50%) translateY(12px) } }
.brand{display:flex; align-items:center; gap:12px; margin-bottom:6px;}
.logo{width:52px; height:52px; background:linear-gradient(135deg,var(--morado),var(--morado-2)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:18px; box-shadow:0 6px 20px rgba(125,43,255,0.12);}
.brand h1{ font-size:18px; margin:0; color:var(--morado-2);}
.brand p{ margin:0; opacity:0.75; font-size:13px; color: #dcd4ff;}
form{display:grid; gap:12px; margin-top:14px;}
.row{display:flex; gap:12px;}
.col{flex:1;}
label{display:block; font-size:13px; margin-bottom:6px; color:rgba(230,222,255,0.9);}
input[type="text"], input[type="email"], input[type="password"]{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(8,6,10,0.6); color:var(--texto); outline:none; font-size:14px; transition: box-shadow .18s, border-color .18s, transform .12s;}
input:focus{box-shadow: 0 6px 28px rgba(125,43,255,0.06); border-color:rgba(125,43,255,0.28); transform:translateY(-1px);}
.invite{display:flex; gap:8px; align-items:center;}
.invite input[readonly]{opacity:0.9; background:rgba(255,255,255,0.02); cursor:not-allowed;}
.pass-wrap{position:relative;}
.toggle-pass{position:absolute; right:10px; top:50%; transform:translateY(-50%); background:transparent; border:none; color:rgba(255,255,255,0.6); cursor:pointer; font-size:13px;}
.terms{display:flex; align-items:center; gap:10px; font-size:13px; margin-top:6px; justify-content:center;}
.terms input{transform:scale(1.05);}
.actions{display:flex; gap:12px; margin-top:6px; justify-content:space-between; align-items:center; flex-wrap:wrap;}
.btn{padding:11px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size:14px; background: linear-gradient(90deg,var(--morado),var(--morado-2)); color:white; box-shadow:0 8px 30px rgba(125,43,255,0.12);}
.btn.secondary{background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ddd;}
.small{font-size:13px; opacity:0.85; text-align:center; margin-top:8px;}
.toasts{position:fixed; right:18px; top:18px; display:flex; flex-direction:column; gap:10px; z-index:9999;}
.toast{min-width:220px; max-width:320px; padding:12px 14px; border-radius:10px; color:white; font-size:14px; box-shadow:0 8px 30px rgba(4,4,8,0.6); transform:translateY(-10px); opacity:0; animation: toastIn .32s forwards;}
.toast.success{background: linear-gradient(90deg, rgba(69,197,122,1), rgba(38,171,109,1));}
.toast.error{background: linear-gradient(90deg, rgba(255,107,107,1), rgba(255,80,80,1));}
.toast.info{background: linear-gradient(90deg, rgba(125,43,255,1), rgba(176,98,255,1));}
@keyframes toastIn{from{transform:translateY(-6px) scale(.98);opacity:0}to{transform:none;opacity:1}}
@keyframes toastOut{to{transform:translateY(-10px) scale(.98);opacity:0}}
.success-anim{position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.2); z-index:9998; pointer-events:none; opacity:0; transform:scale(0.9); transition:all 0.5s ease-out;}
.success-anim.show{opacity:1; transform:scale(1); pointer-events:auto;}
.success-anim span{font-size:28px; color:var(--morado-2); font-weight:900; text-shadow:0 0 8px rgba(125,43,255,0.6),0 0 18px rgba(176,98,255,0.4);}
@media (max-width:520px){.row{flex-direction:column}.brand h1{font-size:16px}.logo{width:48px;height:48px}.card{padding:18px}}
.corner-glow{position:absolute; right:-120px; top:-60px; width:320px; height:320px; background: radial-gradient(circle at 20% 20%, rgba(125,43,255,0.14), transparent 20%), radial-gradient(circle at 80% 80%, rgba(176,98,255,0.08), transparent 30%); filter:blur(30px); pointer-events:none; transform:rotate(25deg);}
</style>
</head>
<body>
<div class="bg"><div class="stars"></div></div>
<div class="logo-float">CG</div>

<div class="wrap">
  <div class="card" role="main" aria-labelledby="h-create">
    <div class="corner-glow" aria-hidden="true"></div>
    <div class="brand" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="logo" aria-hidden="true">CG</div>
        <div>
          <h1 id="h-create">Crea tu cuenta</h1>
          <p>Comienza a generar ganancias con herramientas inteligentes</p>
        </div>
      </div>
      <div style="text-align:right; font-size:13px; opacity:0.85;">
        ¿Ya tienes cuenta? <a href="login.html" style="color:var(--morado-2); text-decoration:none; font-weight:600;">Inicia sesión</a>
      </div>
    </div>

    <form id="formReg" autocomplete="on" novalidate>
      <div class="row">
        <div class="col"><label for="username">Usuario</label><input id="username" name="username" type="text" placeholder="Tu nombre de usuario" required></div>
        <div class="col"><label for="email">Correo electrónico</label><input id="email" name="email" type="email" placeholder="tucorreo@ejemplo.com" required></div>
      </div>

      <div class="row">
        <div class="col pass-wrap"><label for="password">Contraseña</label><input id="password" name="password" type="password" placeholder="Crea una contraseña segura" required minlength="6"><button type="button" class="toggle-pass" aria-label="Mostrar contraseña" data-target="password">Mostrar</button></div>
        <div class="col pass-wrap"><label for="password2">Repetir contraseña</label><input id="password2" name="password2" type="password" placeholder="Vuelve a escribir la contraseña" required minlength="6"><button type="button" class="toggle-pass" aria-label="Mostrar contraseña" data-target="password2">Mostrar</button></div>
      </div>

      <div><label for="invite">Código de invitación</label><div class="invite"><input id="invite" name="invite" type="text" readonly placeholder="Se autocompleta desde el link de invitación" /></div></div>

      <div class="terms" style="margin-top:12px;"><input id="terms" type="checkbox" aria-label="Acepto términos" /><label for="terms" style="margin:0">Acepto los <a href="terminos.html" target="_blank" style="color:var(--morado-2); text-decoration:none;">Términos y condiciones</a></label></div>

      <div class="actions">
        <div style="flex:1; display:flex; align-items:center;"><button type="submit" class="btn" id="btnCreate">Crear cuenta</button></div>
        <div style="min-width:180px; display:flex; justify-content:flex-end;"><button type="button" class="btn secondary" id="btnCancel" onclick="location.href='login.html'">Volver al login</button></div>
      </div>

      <div class="small" style="margin-top:12px; color:rgba(220,215,255,0.8);">
        ClashGPT — Plataforma de automatización y generación de ganancias. Protegemos tu privacidad y tus datos.
      </div>
    </form>
  </div>
</div>

<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>
<div class="success-anim" id="successAnim"><span>¡Registro exitoso!</span></div>

<!-- Firebase compat (funciona desde file:// y en Acode sin servidor) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ===========================
   Firebase (compat) - configuración + lógica mejorada
   =========================== */

// Tu config (storageBucket corregido)
const firebaseConfig = {
  apiKey: "AIzaSyB0JbG_AXXOveg1lERODRJ8xw5vAtEMzV4",
  authDomain: "clashgpt-8a055.firebaseapp.com",
  projectId: "clashgpt-8a055",
  storageBucket: "clashgpt-8a055.appspot.com",
  messagingSenderId: "152687596916",
  appId: "1:152687596916:web:8c8068c6d347d9d9198821"
};

// Inicializar
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// UI refs
const form = document.getElementById('formReg');
const usernameInput = document.getElementById('username');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const password2Input = document.getElementById('password2');
const inviteInput = document.getElementById('invite');
const termsCheckbox = document.getElementById('terms');
const toasts = document.getElementById('toasts');
const btnCreate = document.getElementById('btnCreate');
const successAnim = document.getElementById('successAnim');

// Toast helper
function showToast(message,type='info',timeout=3800){
  const t = document.createElement('div'); t.className=`toast ${type}`; t.innerText=message;
  toasts.appendChild(t);
  setTimeout(()=>{ t.style.animation='toastOut .28s forwards'; setTimeout(()=>t.remove(),300)},timeout);
}

// Toggle pass
document.querySelectorAll('.toggle-pass').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const target = document.getElementById(btn.dataset.target);
    if(!target) return;
    if(target.type==='password'){target.type='text'; btn.textContent='Ocultar';}
    else{target.type='password'; btn.textContent='Mostrar';}
  });
});

// Prefill invite code from URL params (who invited)
(function(){
  try{
    const params=new URLSearchParams(location.search);
    const ref=params.get('ref')||params.get('r')||'';
    inviteInput.value=ref||'';
  }catch(e){
    inviteInput.value='';
  }
})();

// Generar código de invitación único
function generateInviteCode() {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  let code = '';
  for(let i = 0; i < 6; i++){
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// Verificar unicidad del código (evita colisiones)
async function uniqueInviteCode(){

  // Intenta hasta 6 veces generar un código no existente
  for(let attempt=0; attempt<6; attempt++){
    const candidate = generateInviteCode();
    const q = await db.collection('users').where('inviteCode', '==', candidate).limit(1).get();
    if(q.empty) return candidate;
  }
  // fallback: usa timestamp si colisiona mucho (altamente improbable)
  return 'ID' + Date.now().toString(36).toUpperCase().slice(-6);
}

// ===== Form Submit =====
form.addEventListener('submit', async ev=>{
  ev.preventDefault();
  btnCreate.disabled=true; btnCreate.style.opacity=0.85;

  const username = usernameInput.value.trim();
  const email = emailInput.value.trim().toLowerCase();
  const pass = passwordInput.value;
  const pass2 = password2Input.value;
  const invitedBy = inviteInput.value.trim() || null;

  // Validaciones
  if(!username){ showToast('Introduce un nombre de usuario','error'); focusAndEnable(); return; }
  if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showToast('Introduce un correo válido','error'); focusAndEnable(); return; }
  if(pass.length<6){ showToast('La contraseña debe tener al menos 6 caracteres','error'); focusAndEnable(); return; }
  if(pass!==pass2){ showToast('Las contraseñas no coinciden','error'); focusAndEnable(); return; }
  if(!termsCheckbox.checked){ showToast('Debes aceptar los términos y condiciones','error'); focusAndEnable(); return; }

  showToast('Registrando cuenta...','info',2000);

  try{
    // 1) Registrar en Auth
    const userCred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid = userCred.user.uid;

    // 2) Intentar actualizar displayName (no crítico)
    try{
      await userCred.user.updateProfile({ displayName: username });
    }catch(e){
      console.warn('No se pudo actualizar displayName', e);
    }

    // 3) Generar inviteCode propio y asegurar unicidad
    const myInvite = await uniqueInviteCode();

    // 4) Preparar documento usuario (balance cero + invitedBy si aplica)
    const userDoc = {
      username: username,
      email: email,
      provider: 'password',
      balance: 0,
      inviteCode: myInvite,
      invitedBy: invitedBy || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // 5) Guardar en Firestore
    await db.collection('users').doc(uid).set(userDoc, { merge: true });

    // Opcional: si invitedBy existe puedes registrar relación en otra colección (audit)
    if(invitedBy){
      await db.collection('referrals').add({
        invitedAt: firebase.firestore.FieldValue.serverTimestamp(),
        invitedUid: uid,
        invitedByCode: invitedBy,
        inviteCode: myInvite
      }).catch(()=>{/* no crítico */});
    }

    // Mostrar animación de éxito y redirigir
    successAnim.classList.add('show');
    setTimeout(()=>{ location.href='login.html'; },1600);

  }catch(err){
    console.error(err);
    let msg='Ocurrió un error al crear la cuenta.';
    if(err && err.code){
      if(err.code==='auth/email-already-in-use') msg='El correo ya está en uso.';
      else if(err.code==='auth/invalid-email') msg='Correo electrónico inválido.';
      else if(err.code==='auth/weak-password') msg='La contraseña es muy débil.';
      else if(err.code==='auth/operation-not-allowed') msg='Registro deshabilitado en Firebase.';
    } else if(err && err.message) msg=err.message;
    showToast(msg,'error',4800);
    focusAndEnable();
  }

  function focusAndEnable(){
    btnCreate.disabled=false; btnCreate.style.opacity=1; usernameInput.focus();
  }

});
</script>
</body>
</html>
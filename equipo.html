<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Equipo</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;background:#0d0d0f;font-family:Arial,sans-serif;color:#fff}
header{width:100%;background:linear-gradient(180deg,#1a1a1f,#111114);padding:20px 0;text-align:center;border-bottom:1px solid #222;box-shadow:0 4px 20px rgba(176,98,255,.15);font-size:22px;font-weight:bold}
.team-container{padding:20px;padding-bottom:140px}
.summary-box{background:#15151a;border-radius:16px;padding:20px;border:1px solid #252525;margin-bottom:25px;box-shadow:0 0 15px rgba(176,98,255,.08)}
.summary-item{font-size:16px;margin-bottom:5px}
.ref-link-box{margin-top:15px;padding:12px;background:#1a1a20;border-radius:10px;border:1px solid #333;font-size:14px;word-wrap:break-word}
.copy-btn{margin-top:10px;padding:10px;width:100%;background:#b062ff;border:none;border-radius:10px;color:#fff;cursor:pointer;font-size:14px}
.card{background:#15151a;border-radius:16px;padding:15px;border:1px solid #252525;margin-bottom:15px;display:flex;gap:12px;box-shadow:0 0 15px rgba(176,98,255,.07);opacity:0;transform:translateY(12px);animation:fadeIn .4s ease forwards;position:relative}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
.avatar{width:55px;height:55px;border-radius:50%;object-fit:cover;border:2px solid #b062ff55}
.ref-info{flex-grow:1}
.ref-info div{margin-bottom:4px}
.ref-name{font-size:16px;font-weight:bold}
.ref-vip{font-size:13px;background:#b062ff33;border:1px solid #b062ff66;padding:2px 8px;border-radius:10px;display:inline-block;margin-top:2px}
.ref-numbers{margin-top:8px;font-size:14px}
.vp-link{margin-top:12px;color:#b062ff;font-weight:600;cursor:pointer;display:inline-block}
.approved-sticker{position:absolute;top:10px;right:10px;background:#b062ff;color:#fff;font-size:12px;font-weight:bold;padding:4px 6px;border-radius:8px;box-shadow:0 2px 6px rgba(176,98,255,.5)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal-backdrop.show{display:flex}
.modal{width:92%;max-width:520px;background:#0f0f12;border:1px solid #2a2a2a;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(11,6,20,.6);color:#ddd}
.modal h3{margin:0 0 8px;color:#b062ff}
.modal p{margin:6px 0;line-height:1.4;font-size:14px}
.modal .btn-close{margin-top:12px;padding:10px 12px;background:#b062ff;border:none;color:#fff;border-radius:8px;cursor:pointer}
.bottom-bar{position:fixed;bottom:0;left:0;right:0;height:78px;background:#0c0c10;border-top:1px solid #1e1e1e;display:flex;justify-content:space-around;padding-top:8px;z-index:50;box-shadow:0 -4px 20px rgba(176,98,255,.08)}
.bottom-item{display:flex;flex-direction:column;align-items:center;color:#777;font-size:12px;cursor:pointer}
.bottom-item .icon{font-size:22px;margin-bottom:4px}
.bottom-item.active{color:#b062ff}
.section-title{margin-top:10px;margin-bottom:8px;color:#ccc;font-weight:700}
.copy-toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(20px);background:#b062ff;color:#fff;padding:12px 20px;border-radius:12px;font-size:15px;opacity:0;pointer-events:none;box-shadow:0 4px 14px rgba(176,98,255,.4);z-index:999999;transition:all .35s ease}
.copy-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>

<body>

<header>Mi Equipo</header>

<div class="team-container">
  <div class="summary-box">
    <div class="summary-item">Total miembros: <span id="totalMembers">0</span></div>
    <div class="summary-item">Ganancia total generada: <span id="totalEarnings">0 USDT</span></div>
    <div class="ref-link-box" id="refLink"></div>
    <button class="copy-btn" onclick="copyLink()">Copiar enlace</button>
    <div class="vp-link" id="vpLink">Requisitos VP</div>
  </div>

  <div class="section-title">Nivel 1 (directos)</div>
  <div id="level1Container"></div>

  <div class="section-title">Nivel 2 (indirectos)</div>
  <div id="level2Container"></div>
</div>

<!-- ✅ MODAL REQUISITOS VP -->
<div class="modal-backdrop" id="vpModal">
  <div class="modal">
    <h3>Requisitos VP</h3>
    <p><strong>VP0 → VP1</strong><br>• 5 referidos Nivel 1</p>
    <p><strong>VP1 → VP2</strong><br>• 10 referidos Nivel 1<br>• 5 referidos Nivel 2</p>
    <p><strong>VP2 → VP3</strong><br>• 20 referidos Nivel 1<br>• 10 referidos Nivel 2</p>
    <button class="btn-close" onclick="vpModal.classList.remove('show')">Cerrar</button>
  </div>
</div>

<div class="bottom-bar">
  <div class="bottom-item" onclick="location.href='dashboard.html'"><div class="icon"><i class="fa-solid fa-house"></i></div>Home</div>
  <div class="bottom-item" onclick="location.href='invest.html'"><div class="icon"><i class="fa-solid fa-chart-line"></i></div>Invest</div>
  <div class="bottom-item active"><div class="icon"><i class="fa-solid fa-users"></i></div>Equipo</div>
  <div class="bottom-item" onclick="location.href='wallet.html'"><div class="icon"><i class="fa-solid fa-wallet"></i></div>Wallet</div>
  <div class="bottom-item" onclick="location.href='Support.html'"><div class="icon"><i class="fa-solid fa-headset"></i></div>Soporte</div>
</div>

<div id="copyToast" class="copy-toast">✔ Enlace copiado</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyB0JbG_AXXOveg1lERODRJ8xw5vAtEMzV4",
  authDomain:"clashgpt-8a055.firebaseapp.com",
  projectId:"clashgpt-8a055"
});
const auth=firebase.auth();
const db=firebase.firestore();

const money=n=>Number(n||0).toFixed(2)+" USDT";
const avatar=s=>s&&s.length>5?s:"https://cdn-icons-png.flaticon.com/512/149/149071.png";

function copyLink(){
  navigator.clipboard.writeText(refLink.textContent);
  copyToast.classList.add("show");
  setTimeout(()=>copyToast.classList.remove("show"),1200);
}

/* ✅ abrir modal VP */
vpLink.onclick=()=>vpModal.classList.add("show");

let me=null,invite=null;

auth.onAuthStateChanged(async u=>{
  if(!u){location.href="login.html";return;}
  me=u;
  const m=await db.collection("users").doc(u.uid).get();
  invite=m.data().inviteCode;
  refLink.textContent=`${location.origin}/invite.html?ref=${invite}`;
  render();
});

async function render(){
  level1Container.innerHTML="";
  level2Container.innerHTML="";
  let total=0,earn=0;

  const rewardsSnap=await db.collection("rewards")
    .where("toUid","==",me.uid).get();

  const byUser={};
  rewardsSnap.forEach(d=>{
    const r=d.data();
    byUser[r.fromUid]=(byUser[r.fromUid]||0)+Number(r.amount||0);
    earn+=Number(r.amount||0);
  });

  // Nivel 1
  const q1=await db.collection("users").where("invitedBy","==",invite).get();
  total+=q1.size;
  for(const d of q1.docs){
    const u=d.data();
    const g=byUser[d.id]||0;
    const approved=g>0 ? '<div class="approved-sticker">✔ Aprobado</div>' : '';
    level1Container.innerHTML+=`
    <div class="card">
      <img class="avatar" src="${avatar(u.avatar)}">
      <div class="ref-info">
        <div class="ref-name">${u.username||u.email}</div>
        <div class="ref-vip">Nivel 1</div>
        <div class="ref-numbers">Ganancia generada:
        <strong style="color:#4fe36a">${money(g)}</strong></div>
      </div>
      ${approved}
    </div>`;
  }

  // Nivel 2 (indirectos)
  const q2=await db.collection("users").where("invitedBy","in",q1.docs.map(d=>d.data().inviteCode)).get();
  for(const d of q2.docs){
    const u=d.data();
    const g=byUser[d.id]||0;
    const approved=g>0 ? '<div class="approved-sticker">✔ Aprobado</div>' : '';
    level2Container.innerHTML+=`
    <div class="card">
      <img class="avatar" src="${avatar(u.avatar)}">
      <div class="ref-info">
        <div class="ref-name">${u.username||u.email}</div>
        <div class="ref-vip">Nivel 2</div>
        <div class="ref-numbers">Ganancia generada:
        <strong style="color:#4fe36a">${money(g)}</strong></div>
      </div>
      ${approved}
    </div>`;
  }

  totalMembers.textContent=total;
  totalEarnings.textContent=money(earn);

  // ✅ actualizar VP
  await updateVP();
}

async function updateVP(){
  let nivel1Aprob = level1Container.querySelectorAll('.approved-sticker').length;
  let nivel2Aprob = level2Container.querySelectorAll('.approved-sticker').length;
  let vp = 0;

  if(nivel1Aprob >= 5) vp = 1;
  if(nivel1Aprob >= 10 && nivel2Aprob >= 5) vp = 2;
  if(nivel1Aprob >= 20 && nivel2Aprob >= 10) vp = 3;

  await db.collection("users").doc(me.uid).update({ vpLevel: vp });
}
</script>
</body>
</html>
